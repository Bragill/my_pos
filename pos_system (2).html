<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∏‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ô</title>
    <meta name="description" content="‡∏£‡∏∞‡∏ö‡∏ö POS ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏° PWA ‡πÅ‡∏•‡∏∞ Google Sheets">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUE9TIFN5c3RlbSIsInNob3J0X25hbWUiOiJQT1MiLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMzYjgyZjYiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTWpRaUlHaGxhV2RvZEQwaU1qUWlJSFpwWlhkQ2IzZzlJakFnTUNBeU5DQXlOQ0lnWm1sc2JEMGlJek5pT0RKbU5pSWdlRzFzYm5NOUltaDBkSEE2THk5M2QzY3Vkek11YjNKbkx6SXdNREF2YzNabklqNDhhbkpsWTNRZ2VEMGlOaUlnZVQwaU5pSWdkMmxrZEdnOUlqRXlJaUJvWldsbmFIUTlJakV5SWlCeWVEMGlNaUlnWm1sc2JEMGlJM1ptWmlJdlBqeDBaWGgwSUhnOUlqRXlJaUI1UFNJeE5TSWdabWxzYkQwaUl6TmlPREptTmlJZ1ptOXVkQzF6YVhwbFBTSTJJaUIwWlhoMExXRnVZMmh2Y2owaWJXbGtaR3hsSWo1UVQxTThMM1JsZUhRK1BEWHNMM04yWno0PSIsInNpemVzIjoiMjR4MjQiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="POS System">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            margin: 5px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .nav-tab.active, .nav-tab:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(15px);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
        }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #047857);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .card {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(59,130,246,0.1);
            border-radius: 10px;
            border-left: 4px solid #3b82f6;
        }

        .stats-card {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            margin: 10px 0;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid;
        }

        .alert-success {
            background: rgba(16,185,129,0.1);
            border-color: #10b981;
            color: #047857;
        }

        .alert-warning {
            background: rgba(245,158,11,0.1);
            border-color: #f59e0b;
            color: #d97706;
        }

        .alert-danger {
            background: rgba(239,68,68,0.1);
            border-color: #ef4444;
            color: #dc2626;
        }

        .qr-container {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 15px;
            margin: 20px 0;
        }

        .invoice {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .invoice-header {
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .invoice-total {
            font-weight: bold;
            font-size: 1.2rem;
            padding-top: 15px;
            border-top: 2px solid #333;
        }

        .low-stock {
            background: rgba(239,68,68,0.1);
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.7); }
            to { opacity: 1; transform: scale(1); }
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #333;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-direction: column;
                align-items: center;
            }

            .nav-tab {
                width: 200px;
                text-align: center;
            }

            .tab-content {
                padding: 20px;
            }

            .cart-item {
                flex-direction: column;
                text-align: center;
            }

            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .scanner-container {
            text-align: center;
            padding: 20px;
            background: rgba(59,130,246,0.1);
            border-radius: 10px;
            margin: 20px 0;
        }

        .hidden {
            display: none !important;
        }

        .last-save {
            text-align: center;
            margin: 20px 0;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè™ POS System</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∏‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏° PWA ‡πÅ‡∏•‡∏∞ Google Sheets</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('sell')">üí∞ ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            <div class="nav-tab" onclick="showTab('stock-in')">‚ûï ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            <div class="nav-tab" onclick="showTab('inventory')">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á</div>
            <div class="nav-tab" onclick="showTab('reports')">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
            <div class="nav-tab" onclick="showTab('settings')">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        </div>

        <!-- ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
        <div id="sell" class="tab-content active">
            <div class="grid grid-2">
                <div class="card">
                    <h3>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div class="form-group">
                        <label>‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î / ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <input type="text" id="searchProduct" class="form-control" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                    </div>
                    <div class="form-group">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <select id="productSelect" class="form-control">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                        <input type="number" id="sellQuantity" class="form-control" value="1" min="1">
                    </div>
                    <button class="btn btn-success" onclick="addToCart()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
                </div>

                <div class="card">
                    <h3>üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div id="cartItems"></div>
                    <div class="stats-card">
                        <div class="stats-number" id="cartTotal">‡∏ø 0</div>
                        <div>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div>
                    </div>
                    <div class="form-group">
                        <label>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <input type="number" id="receivedAmount" class="form-control" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</label>
                        <input type="number" id="changeAmount" class="form-control" readonly>
                    </div>
                    <button class="btn btn-primary" onclick="processSale()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                    <button class="btn btn-warning" onclick="clearCart()">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
                </div>
            </div>
        </div>

        <!-- ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
        <div id="stock-in" class="tab-content">
            <div class="card">
                <h3>‚ûï ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</label>
                        <input type="text" id="newBarcode" class="form-control" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î">
                    </div>
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <input type="text" id="newProductName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                    </div>
                    <div class="form-group">
                        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label>
                        <input type="number" id="newSellPrice" class="form-control" placeholder="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô</label>
                        <input type="number" id="newCostPrice" class="form-control" placeholder="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                        <input type="number" id="newQuantity" class="form-control" placeholder="0" min="1">
                    </div>
                    <div class="form-group">
                        <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ä‡∏¥‡πâ‡∏ô)</label>
                        <input type="number" id="newMinStock" class="form-control" placeholder="5" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isBulkPurchase"> ‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏ö‡∏ö‡∏¢‡∏Å‡πÅ‡∏û‡πá‡∏Ñ
                    </label>
                </div>
                
                <div id="bulkPurchaseFields" class="hidden">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏û‡πá‡∏Ñ</label>
                            <input type="number" id="packQuantity" class="form-control" placeholder="0" min="1">
                        </div>
                        <div class="form-group">
                            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡πÅ‡∏û‡πá‡∏Ñ</label>
                            <input type="number" id="packPrice" class="form-control" placeholder="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÅ‡∏û‡πá‡∏Ñ</label>
                            <input type="number" id="piecesPerPack" class="form-control" placeholder="0" min="1">
                        </div>
                        <div class="form-group">
                            <label>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
                            <input type="number" id="calculatedCostPerPiece" class="form-control" readonly>
                        </div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="addStock()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πä‡∏≠‡∏Å</button>
                <button class="btn btn-primary" onclick="loadExistingProducts()">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°</button>
            </div>

            <div id="stockInResult" class="alert alert-success hidden">
                <strong>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
            </div>
        </div>

        <!-- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á -->
        <div id="inventory" class="tab-content">
            <div class="card">
                <h3>üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á</h3>
                <div class="form-group">
                    <input type="text" id="inventorySearch" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...">
                </div>
                <button class="btn btn-primary" onclick="loadInventory()">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button class="btn btn-warning" onclick="checkLowStock()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</button>
                
                <div id="inventoryList"></div>
                
                <div id="lowStockAlert" class="hidden">
                    <h4>‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</h4>
                    <div id="lowStockList"></div>
                </div>
            </div>
        </div>

        <!-- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
        <div id="reports" class="tab-content">
            <div class="grid grid-3">
                <div class="stats-card">
                    <div class="stats-number" id="todayRevenue">‡∏ø 0</div>
                    <div>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="todayProfit">‡∏ø 0</div>
                    <div>‡∏Å‡∏≥‡πÑ‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="todayOrders">0</div>
                    <div>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                </div>
            </div>

            <div class="card">
                <h3>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3>
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                    <select id="reportPeriod" class="form-control">
                        <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                        <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                        <option value="year">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="generateReport()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                <button class="btn btn-success" onclick="sendLineNotify()">‡∏™‡πà‡∏á LINE Notify</button>
                
                <div id="reportResults"></div>
            </div>
        </div>

        <!-- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ -->
        <div id="settings" class="tab-content">
            <div class="grid grid-2">
                <div class="card">
                    <h3>üîó Google Sheets</h3>
                    <div class="form-group">
                        <label>Google Apps Script URL</label>
                        <input type="url" id="gasUrl" class="form-control" placeholder="https://script.google.com/macros/s/.../exec">
                    </div>
                    <div class="form-group">
                        <label>Sheet ID</label>
                        <input type="text" id="sheetId" class="form-control" placeholder="1ABC...xyz">
                    </div>
                    <button class="btn btn-primary" onclick="testConnection()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
                </div>

                <div class="card">
                    <h3>üí≥ PromptPay</h3>
                    <div class="form-group">
                        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå / ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                        <input type="text" id="promptPayId" class="form-control" placeholder="0812345678">
                    </div>
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
                        <input type="text" id="storeName" class="form-control" placeholder="‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô">
                    </div>
                </div>

                <div class="card">
                    <h3>üì± LINE Notify</h3>
                    <div class="form-group">
                        <label>LINE Token</label>
                        <input type="text" id="lineToken" class="form-control" placeholder="LINE Notify Token">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoNotify"> ‡∏™‡πà‡∏á‡∏¢‡∏≠‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô
                        </label>
                    </div>
                    <button class="btn btn-success" onclick="testLineNotify()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö LINE</button>
                </div>

                <div class="card">
                    <h3>üö® ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                    <div class="form-group">
                        <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ä‡∏¥‡πâ‡∏ô)</label>
                        <input type="number" id="defaultMinStock" class="form-control" value="5" min="0">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </div>
            </div>
        </div>
    </div>

    <div id="lastSaved" class="last-save"></div>

    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeInvoiceModal()">&times;</span>
            <div id="invoiceContent"></div>
            <div class="qr-container">
                <div id="qrCode"></div>
                <p>‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
            </div>
            <button class="btn btn-primary" onclick="downloadInvoice()">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</button>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <!-- html2canvas for invoice download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Google Sheets)
        let inventory = JSON.parse(localStorage.getItem('pos_inventory') || '[]');
        let sales = JSON.parse(localStorage.getItem('pos_sales') || '[]');
        let cart = [];
        let settings = JSON.parse(localStorage.getItem('pos_settings') || '{}');

        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGNvbnNvbGUubG9nKCdTVzogSW5zdGFsbGVkJyk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdhY3RpdmF0ZScsIGV2ZW50ID0+IHsKICBjb25zb2xlLmxvZygnU1c6IEFjdGl2YXRlZCcpOwp9KTs=')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ó‡πá‡∏ö
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö
            if (tabName === 'sell') {
                loadProductsForSell();
            } else if (tabName === 'inventory') {
                loadInventory();
            } else if (tabName === 'reports') {
                loadReports();
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
        function loadProductsForSell() {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
            
            inventory.forEach((item, index) => {
                if (item.quantity > 0) {
                    select.innerHTML += `<option value="${index}">${item.name} - ‡∏ø${item.sellPrice} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.quantity})</option>`;
                }
            });
        }

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        document.getElementById('searchProduct').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const select = document.getElementById('productSelect');
            
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠
            const found = inventory.find(item => 
                item.barcode === e.target.value || 
                item.name.toLowerCase().includes(searchTerm)
            );
            
            if (found && found.quantity > 0) {
                const index = inventory.indexOf(found);
                select.value = index;
                document.getElementById('sellQuantity').focus();
            }
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        function addToCart() {
            const productIndex = document.getElementById('productSelect').value;
            const quantity = parseInt(document.getElementById('sellQuantity').value) || 1;
            
            if (!productIndex) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
                return;
            }
            
            const product = inventory[productIndex];
            if (product.quantity < quantity) {
                alert('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠');
                return;
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const existingItem = cart.find(item => item.productIndex == productIndex);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    productIndex: parseInt(productIndex),
                    name: product.name,
                    sellPrice: product.sellPrice,
                    costPrice: product.costPrice,
                    quantity: quantity
                });
            }
            
            updateCartDisplay();
            document.getElementById('sellQuantity').value = 1;
            document.getElementById('productSelect').value = '';
            document.getElementById('searchProduct').value = '';
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á</p>';
                cartTotal.textContent = '‡∏ø 0';
                return;
            }
            
            let total = 0;
            cartItems.innerHTML = '';
            
            cart.forEach((item, index) => {
                const itemTotal = item.sellPrice * item.quantity;
                total += itemTotal;
                
                cartItems.innerHTML += `
                    <div class="cart-item">
                        <div>
                            <strong>${item.name}</strong><br>
                            ‡∏ø${item.sellPrice} √ó ${item.quantity} = ‡∏ø${itemTotal}
                        </div>
                        <button class="btn btn-danger" onclick="removeFromCart(${index})">‡∏•‡∏ö</button>
                    </div>
                `;
            });
            
            cartTotal.textContent = `‡∏ø ${total.toLocaleString()}`;
            calculateChange();
        }

        // ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
        }

        // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        function clearCart() {
            cart = [];
            updateCartDisplay();
            document.getElementById('receivedAmount').value = '';
            document.getElementById('changeAmount').value = '';
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô
        function calculateChange() {
            const received = parseFloat(document.getElementById('receivedAmount').value) || 0;
            const total = cart.reduce((sum, item) => sum + (item.sellPrice * item.quantity), 0);
            const change = received - total;
            
            document.getElementById('changeAmount').value = change >= 0 ? change.toFixed(2) : '';
        }

        document.getElementById('receivedAmount').addEventListener('input', calculateChange);

        // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
        function processSale() {
            if (cart.length === 0) {
                alert('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á');
                return;
            }

            const receivedField = document.getElementById('receivedAmount');
            const receivedStr = receivedField.value.trim();
            const total = cart.reduce((sum, item) => sum + (item.sellPrice * item.quantity), 0);

            if (receivedStr === '') {
                const sale = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    items: [...cart],
                    total: total,
                    received: 0,
                    change: total,
                    profit: cart.reduce((sum, item) => sum + ((item.sellPrice - item.costPrice) * item.quantity), 0)
                };
                showInvoice(sale);
                return;
            }

            const received = parseFloat(receivedStr) || 0;

            if (received < total) {
                alert('‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠');
                return;
            }

            // ‡∏•‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å
            cart.forEach(cartItem => {
                inventory[cartItem.productIndex].quantity -= cartItem.quantity;
            });

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
            const sale = {
                id: Date.now(),
                date: new Date().toISOString(),
                items: [...cart],
                total: total,
                received: received,
                change: received - total,
                profit: cart.reduce((sum, item) => sum + ((item.sellPrice - item.costPrice) * item.quantity), 0)
            };

            sales.push(sale);

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            localStorage.setItem('pos_inventory', JSON.stringify(inventory));
            localStorage.setItem('pos_sales', JSON.stringify(sales));

            // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
            showInvoice(sale);

            // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            clearCart();
            loadProductsForSell(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
        function showInvoice(sale) {
            const modal = document.getElementById('invoiceModal');
            const invoiceContent = document.getElementById('invoiceContent');
            const storeName = settings.storeName || '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô';

            let itemsHtml = '';
            sale.items.forEach(item => {
                const itemTotal = item.sellPrice * item.quantity;
                itemsHtml += `
                    <div class="invoice-item">
                        <span>${item.name} √ó ${item.quantity}</span>
                        <span>‡∏ø${itemTotal.toLocaleString()}</span>
                    </div>
                `;
            });

            const paymentHtml = sale.received < sale.total
                ? `<div class="invoice-item">
                        <span>‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span>
                        <span>‡∏ø${(sale.total - sale.received).toLocaleString()}</span>
                   </div>`
                : `<div class="invoice-item">
                        <span>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span>
                        <span>‡∏ø${sale.received.toLocaleString()}</span>
                   </div>
                   <div class="invoice-item">
                        <span>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</span>
                        <span>‡∏ø${sale.change.toLocaleString()}</span>
                   </div>`;

            invoiceContent.innerHTML = `
                <div class="invoice">
                    <div class="invoice-header">
                        <h2>${storeName}</h2>
                        <p>${sale.received < sale.total ? '‡πÉ‡∏ö PR' : '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤'} #${sale.id}</p>
                        <p>${new Date(sale.date).toLocaleString('th-TH')}</p>
                    </div>
                    ${itemsHtml}
                    <div class="invoice-item invoice-total">
                        <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        <span>‡∏ø${sale.total.toLocaleString()}</span>
                    </div>
                    ${paymentHtml}
                </div>
            `;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code PromptPay
            generatePromptPayQR(sale.total);
            
            modal.style.display = 'block';
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code PromptPay
        function generatePromptPayQR(amount) {
            const promptPayId = settings.promptPayId || '0812345678';
            const qr = new QRious({
                element: document.getElementById('qrCode'),
                value: generatePromptPayString(promptPayId, amount),
                size: 200
            });
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏ï‡∏£‡∏¥‡∏á PromptPay
        function generatePromptPayString(id, amount) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á PromptPay QR ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡∏ò‡∏õ‡∏ó.
            let qrString = '00020101021129370016A000000677010111';
            qrString += '0013' + id.padStart(13, '0');
            qrString += '5802TH';
            qrString += '54' + String(amount.toFixed(2)).padStart(2, '0') + String(amount.toFixed(2));
            qrString += '6304';
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì CRC16
            const crc = calculateCRC16(qrString);
            qrString += crc;
            
            return qrString;
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì CRC16 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PromptPay)
        function calculateCRC16(data) {
            let crc = 0xFFFF;
            for (let i = 0; i < data.length; i++) {
                crc ^= data.charCodeAt(i) << 8;
                for (let j = 0; j < 8; j++) {
                    if (crc & 0x8000) {
                        crc = (crc << 1) ^ 0x1021;
                    } else {
                        crc = crc << 1;
                    }
                }
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        }

        // ‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
        function closeInvoiceModal() {
            document.getElementById('invoiceModal').style.display = 'none';
        }

        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
        function downloadInvoice() {
            const invoiceElement = document.querySelector('.invoice');
            html2canvas(invoiceElement).then(canvas => {
                const link = document.createElement('a');
                link.download = `invoice-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // === ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ===
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏ö‡∏ö‡∏¢‡∏Å‡πÅ‡∏û‡πá‡∏Ñ
        document.getElementById('isBulkPurchase').addEventListener('change', function() {
            const bulkFields = document.getElementById('bulkPurchaseFields');
            if (this.checked) {
                bulkFields.classList.remove('hidden');
            } else {
                bulkFields.classList.add('hidden');
            }
        });

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô
        function calculateCostPerPiece() {
            const packQuantity = parseFloat(document.getElementById('packQuantity').value) || 0;
            const packPrice = parseFloat(document.getElementById('packPrice').value) || 0;
            const piecesPerPack = parseFloat(document.getElementById('piecesPerPack').value) || 1;
            
            const totalPieces = packQuantity * piecesPerPack;
            const costPerPiece = totalPieces > 0 ? packPrice / piecesPerPack : 0;
            
            document.getElementById('calculatedCostPerPiece').value = costPerPiece.toFixed(2);
            document.getElementById('newCostPrice').value = costPerPiece.toFixed(2);
            document.getElementById('newQuantity').value = totalPieces;
        }

        ['packQuantity', 'packPrice', 'piecesPerPack'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculateCostPerPiece);
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πä‡∏≠‡∏Å
        function addStock() {
            const barcode = document.getElementById('newBarcode').value;
            const name = document.getElementById('newProductName').value;
            const sellPrice = parseFloat(document.getElementById('newSellPrice').value) || 0;
            const costPrice = parseFloat(document.getElementById('newCostPrice').value) || 0;
            const quantity = parseInt(document.getElementById('newQuantity').value) || 0;
            const minStock = parseInt(document.getElementById('newMinStock').value) || 5;
            
            if (!name || sellPrice <= 0 || costPrice <= 0 || quantity <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            const existingIndex = inventory.findIndex(item => 
                item.barcode === barcode || item.name === name
            );
            
            if (existingIndex !== -1) {
                const existing = inventory[existingIndex];
                
                // ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                if (existing.costPrice === costPrice) {
                    existing.quantity += quantity;
                    existing.sellPrice = sellPrice; // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢
                } else {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á batch ‡πÉ‡∏´‡∏°‡πà
                    const newItem = {
                        id: Date.now(),
                        barcode: barcode + '_' + Date.now(),
                        name: name + ' (Batch ' + new Date().toLocaleDateString('th-TH') + ')',
                        sellPrice: sellPrice,
                        costPrice: costPrice,
                        quantity: quantity,
                        minStock: minStock,
                        dateAdded: new Date().toISOString()
                    };
                    inventory.push(newItem);
                }
            } else {
                // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                const newItem = {
                    id: Date.now(),
                    barcode: barcode,
                    name: name,
                    sellPrice: sellPrice,
                    costPrice: costPrice,
                    quantity: quantity,
                    minStock: minStock,
                    dateAdded: new Date().toISOString()
                };
                inventory.push(newItem);
            }
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            localStorage.setItem('pos_inventory', JSON.stringify(inventory));
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            const result = document.getElementById('stockInResult');
            result.classList.remove('hidden');
            setTimeout(() => result.classList.add('hidden'), 3000);
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
            clearStockForm();
            loadProductsForSell();
        }

        // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å
        function clearStockForm() {
            ['newBarcode', 'newProductName', 'newSellPrice', 'newCostPrice', 'newQuantity', 'newMinStock',
             'packQuantity', 'packPrice', 'piecesPerPack', 'calculatedCostPerPiece'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('isBulkPurchase').checked = false;
            document.getElementById('bulkPurchaseFields').classList.add('hidden');
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
        function loadExistingProducts() {
            const select = document.createElement('select');
            select.className = 'form-control';
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏° --</option>';
            
            inventory.forEach((item, index) => {
                select.innerHTML += `<option value="${index}">${item.name} - ‡∏ø${item.costPrice}</option>`;
            });
            
            select.addEventListener('change', function() {
                if (this.value) {
                    const item = inventory[this.value];
                    document.getElementById('newBarcode').value = item.barcode;
                    document.getElementById('newProductName').value = item.name;
                    document.getElementById('newSellPrice').value = item.sellPrice;
                    document.getElementById('newCostPrice').value = item.costPrice;
                    document.getElementById('newMinStock').value = item.minStock;
                }
            });
            
            // ‡πÅ‡∏™‡∏î‡∏á select ‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏±‡∏•
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°</h3>
                    <div class="form-group">
                        ${select.outerHTML}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // === ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á ===
        
        function loadInventory() {
            const inventoryList = document.getElementById('inventoryList');
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            
            let filteredInventory = inventory;
            if (searchTerm) {
                filteredInventory = inventory.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.barcode.includes(searchTerm)
                );
            }
            
            if (filteredInventory.length === 0) {
                inventoryList.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
                return;
            }
            
            inventoryList.innerHTML = '<h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>';
            filteredInventory.forEach((item, index) => {
                const stockStatus = item.quantity <= item.minStock ? 'low-stock' : '';
                inventoryList.innerHTML += `
                    <div class="card ${stockStatus}">
                        <h5>${item.name}</h5>
                        <p><strong>‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î:</strong> ${item.barcode}</p>
                        <p><strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢:</strong> ‡∏ø${item.sellPrice}</p>
                        <p><strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô:</strong> ‡∏ø${item.costPrice}</p>
                        <p><strong>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</strong> ${item.quantity} ‡∏ä‡∏¥‡πâ‡∏ô</p>
                        <p><strong>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</strong> ${item.minStock} ‡∏ä‡∏¥‡πâ‡∏ô</p>
                        ${item.quantity <= item.minStock ? '<p class="alert alert-warning">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</p>' : ''}
                    </div>
                `;
            });
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î
        function checkLowStock() {
            const lowStockItems = inventory.filter(item => item.quantity <= item.minStock);
            const lowStockAlert = document.getElementById('lowStockAlert');
            const lowStockList = document.getElementById('lowStockList');
            
            if (lowStockItems.length === 0) {
                lowStockAlert.classList.add('hidden');
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î');
                return;
            }
            
            lowStockList.innerHTML = '';
            lowStockItems.forEach(item => {
                lowStockList.innerHTML += `
                    <div class="low-stock">
                        <strong>${item.name}</strong> - ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.quantity} ‡∏ä‡∏¥‡πâ‡∏ô (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.minStock})
                    </div>
                `;
            });
            
            lowStockAlert.classList.remove('hidden');
            
            // ‡∏™‡πà‡∏á LINE Notify ‡∏´‡∏≤‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ
            if (settings.lineToken) {
                sendLowStockNotification(lowStockItems);
            }
        }

        document.getElementById('inventorySearch').addEventListener('input', loadInventory);

        // === ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ===
        
        function loadReports() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            const todaySales = sales.filter(sale => 
                sale.date.split('T')[0] === todayStr
            );
            
            const todayRevenue = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            const todayProfit = todaySales.reduce((sum, sale) => sum + sale.profit, 0);
            const todayOrders = todaySales.length;
            
            document.getElementById('todayRevenue').textContent = `‡∏ø ${todayRevenue.toLocaleString()}`;
            document.getElementById('todayProfit').textContent = `‡∏ø ${todayProfit.toLocaleString()}`;
            document.getElementById('todayOrders').textContent = todayOrders;
        }

        function generateReport() {
            const period = document.getElementById('reportPeriod').value;
            const reportResults = document.getElementById('reportResults');
            
            let filteredSales = [];
            const today = new Date();
            
            switch (period) {
                case 'today':
                    const todayStr = today.toISOString().split('T')[0];
                    filteredSales = sales.filter(sale => 
                        sale.date.split('T')[0] === todayStr
                    );
                    break;
                    
                case 'month':
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    filteredSales = sales.filter(sale => 
                        new Date(sale.date) >= startOfMonth && new Date(sale.date) <= today
                    );
                    break;
                    
                case 'year':
                    const startOfYear = new Date(today.getFullYear(), 0, 1);
                    filteredSales = sales.filter(sale => 
                        new Date(sale.date) >= startOfYear && new Date(sale.date) <= today
                    );
                    break;
            }
            
            const totalRevenue = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            const totalProfit = filteredSales.reduce((sum, sale) => sum + sale.profit, 0);
            const totalOrders = filteredSales.length;
            
            const periodText = {
                'today': '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
                'month': '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ',
                'year': '‡∏õ‡∏µ‡∏ô‡∏µ‡πâ'
            };
            
            reportResults.innerHTML = `
                <div class="card">
                    <h4>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢${periodText[period]}</h4>
                    <div class="grid grid-3">
                        <div class="stats-card">
                            <div class="stats-number">‡∏ø ${totalRevenue.toLocaleString()}</div>
                            <div>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number">‡∏ø ${totalProfit.toLocaleString()}</div>
                            <div>‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number">${totalOrders}</div>
                            <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
                        </div>
                    </div>
                    
                    <h5>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h5>
                    ${filteredSales.map(sale => `
                        <div class="card">
                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(sale.date).toLocaleString('th-TH')}</p>
                            <p><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</strong> ${sale.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                            <p><strong>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢:</strong> ‡∏ø${sale.total.toLocaleString()}</p>
                            <p><strong>‡∏Å‡∏≥‡πÑ‡∏£:</strong> ‡∏ø${sale.profit.toLocaleString()}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // === LINE Notify ===
        
        function sendLineNotify() {
            if (!settings.lineToken) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE Token ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const todaySales = sales.filter(sale => 
                sale.date.split('T')[0] === todayStr
            );
            
            const todayRevenue = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            const todayProfit = todaySales.reduce((sum, sale) => sum + sale.profit, 0);
            const todayOrders = todaySales.length;
            
            const message = `
üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
üè™ ‡∏£‡πâ‡∏≤‡∏ô: ${settings.storeName || '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô'}
üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${today.toLocaleDateString('th-TH')}

üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ‡∏ø${todayRevenue.toLocaleString()}
üìà ‡∏Å‡∏≥‡πÑ‡∏£: ‡∏ø${todayProfit.toLocaleString()}
üõí ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${todayOrders}

#POS #‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
            `.trim();
            
            // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á LINE Notify
            console.log('Sending LINE Notify:', message);
            alert('‡∏™‡πà‡∏á LINE Notify ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function sendLowStockNotification(lowStockItems) {
            if (!settings.lineToken) return;
            
            const itemList = lowStockItems.map(item => 
                `- ${item.name}: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.quantity} ‡∏ä‡∏¥‡πâ‡∏ô`
            ).join('\n');
            
            const message = `
‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î
üè™ ‡∏£‡πâ‡∏≤‡∏ô: ${settings.storeName || '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô'}

${itemList}

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
            `.trim();
            
            console.log('Sending low stock notification:', message);
        }

        function testLineNotify() {
            if (!settings.lineToken) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å LINE Token');
                return;
            }
            
            alert('‡∏ó‡∏î‡∏™‡∏≠‡∏ö LINE Notify ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        // === ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ===
        
        function saveSettings() {
            settings = {
                gasUrl: document.getElementById('gasUrl').value,
                sheetId: document.getElementById('sheetId').value,
                promptPayId: document.getElementById('promptPayId').value,
                storeName: document.getElementById('storeName').value,
                lineToken: document.getElementById('lineToken').value,
                autoNotify: document.getElementById('autoNotify').checked,
                defaultMinStock: parseInt(document.getElementById('defaultMinStock').value) || 5
            };
            
            localStorage.setItem('pos_settings', JSON.stringify(settings));
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function loadSettings() {
            if (settings.gasUrl) document.getElementById('gasUrl').value = settings.gasUrl;
            if (settings.sheetId) document.getElementById('sheetId').value = settings.sheetId;
            if (settings.promptPayId) document.getElementById('promptPayId').value = settings.promptPayId;
            if (settings.storeName) document.getElementById('storeName').value = settings.storeName;
            if (settings.lineToken) document.getElementById('lineToken').value = settings.lineToken;
            if (settings.autoNotify) document.getElementById('autoNotify').checked = settings.autoNotify;
            if (settings.defaultMinStock) document.getElementById('defaultMinStock').value = settings.defaultMinStock;
        }

        function testConnection() {
            const gasUrl = document.getElementById('gasUrl').value;
            if (!gasUrl) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Google Apps Script URL');
                return;
            }
            
            // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            alert('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        // === Google Apps Script Integration ===
        
        function syncWithGoogleSheets() {
            if (!settings.gasUrl) {
                console.log('No Google Apps Script URL configured');
                return;
            }
            
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets
            const data = {
                action: 'sync',
                inventory: inventory,
                sales: sales
            };
            
            fetch(settings.gasUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            }).then(() => {
                console.log('Synced with Google Sheets');
            }).catch(error => {
                console.error('Sync failed:', error);
            });
        }

        // Auto-sync ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(syncWithGoogleSheets, 5 * 60 * 1000);

        // === ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ===
        
        function initializeSystem() {
            loadSettings();
            loadProductsForSell();
            loadReports();
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            const lowStockItems = inventory.filter(item => item.quantity <= item.minStock);
            if (lowStockItems.length > 0) {
                setTimeout(() => {
                    if (confirm(`‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î ${lowStockItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                        showTab('inventory');
                        checkLowStock();
                    }
                }, 2000);
            }
            
            // Auto Daily Report (‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
            if (settings.autoNotify) {
                const now = new Date();
                const lastReport = localStorage.getItem('pos_last_report');
                const today = now.toDateString();
                
                if (lastReport !== today && now.getHours() >= 18) { // ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á 18:00
                    sendLineNotify();
                    localStorage.setItem('pos_last_report', today);
                }
            }
        }

        // === ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ===
        
        function loadSampleData() {
            if (inventory.length === 0) {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                inventory = [
                    {
                        id: 1,
                        barcode: '8850006111101',
                        name: '‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏° 600‡∏°‡∏•.',
                        sellPrice: 10,
                        costPrice: 7,
                        quantity: 50,
                        minStock: 10,
                        dateAdded: new Date().toISOString()
                    },
                    {
                        id: 2,
                        barcode: '8850999320501',
                        name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á',
                        sellPrice: 25,
                        costPrice: 18,
                        quantity: 20,
                        minStock: 5,
                        dateAdded: new Date().toISOString()
                    },
                    {
                        id: 3,
                        barcode: '8851019321456',
                        name: '‡∏Å‡∏≤‡πÅ‡∏ü‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á',
                        sellPrice: 35,
                        costPrice: 25,
                        quantity: 3, // ‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î
                        minStock: 5,
                        dateAdded: new Date().toISOString()
                    }
                ];
                
                localStorage.setItem('pos_inventory', JSON.stringify(inventory));
                console.log('Sample data loaded');
            }
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        loadSampleData();

        // === Camera Scanner (Optional Enhancement) ===
        
        let cameraStream = null;
        
        function startBarcodeScanner() {
            if (!navigator.mediaDevices) {
                alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á');
                return;
            }
            
            const scannerContainer = document.createElement('div');
            scannerContainer.className = 'scanner-container';
            scannerContainer.innerHTML = `
                <h4>üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</h4>
                <video id="scannerVideo" width="300" height="200" autoplay></video>
                <br>
                <button class="btn btn-danger" onclick="stopBarcodeScanner()">‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô</button>
            `;
            
            document.querySelector('.tab-content.active').appendChild(scannerContainer);
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment' // ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
                } 
            })
            .then(stream => {
                cameraStream = stream;
                document.getElementById('scannerVideo').srcObject = stream;
                
                // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô (‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ library ‡∏≠‡∏¢‡πà‡∏≤‡∏á QuaggaJS)
                setTimeout(() => {
                    const mockBarcode = '8850006111101'; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á
                    document.getElementById('searchProduct').value = mockBarcode;
                    document.getElementById('searchProduct').dispatchEvent(new Event('input'));
                    stopBarcodeScanner();
                    alert('‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + mockBarcode);
                }, 3000);
            })
            .catch(error => {
                console.error('Camera access denied:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
            });
        }
        
        function stopBarcodeScanner() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            const scannerContainer = document.querySelector('.scanner-container');
            if (scannerContainer) {
                scannerContainer.remove();
            }
        }

        // === PWA Install Prompt ===
        
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á PWA
            const installButton = document.createElement('button');
            installButton.className = 'btn btn-success';
            installButton.textContent = 'üì± ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ';
            installButton.onclick = installPWA;
            installButton.style.position = 'fixed';
            installButton.style.bottom = '20px';
            installButton.style.right = '20px';
            installButton.style.zIndex = '1000';
            
            document.body.appendChild(installButton);
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installed');
                    }
                    deferredPrompt = null;
                    document.querySelector('button[onclick="installPWA()"]')?.remove();
                });
            }
        }

        // === Keyboard Shortcuts ===
        
        document.addEventListener('keydown', function(e) {
            // F1 = ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (e.key === 'F1') {
                e.preventDefault();
                showTab('sell');
                document.getElementById('searchProduct').focus();
            }
            
            // F2 = ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (e.key === 'F2') {
                e.preventDefault();
                showTab('stock-in');
                document.getElementById('newBarcode').focus();
            }
            
            // F3 = ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á
            if (e.key === 'F3') {
                e.preventDefault();
                showTab('inventory');
            }
            
            // F4 = ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
            if (e.key === 'F4') {
                e.preventDefault();
                showTab('reports');
            }
            
            // Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ = ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            if (e.key === 'Enter' && e.target.id === 'searchProduct') {
                e.preventDefault();
                addToCart();
            }
            
            // Ctrl + Enter = ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                if (document.getElementById('sell').classList.contains('active')) {
                    processSale();
                }
            }
        });

        // === Export/Import Data ===
        
        function exportData() {
            const data = {
                inventory: inventory,
                sales: sales,
                settings: settings,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `pos-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö')) {
                        if (data.inventory) {
                            inventory = data.inventory;
                            localStorage.setItem('pos_inventory', JSON.stringify(inventory));
                        }
                        
                        if (data.sales) {
                            sales = data.sales;
                            localStorage.setItem('pos_sales', JSON.stringify(sales));
                        }
                        
                        if (data.settings) {
                            settings = data.settings;
                            localStorage.setItem('pos_settings', JSON.stringify(settings));
                            loadSettings();
                        }
                        
                        alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        location.reload();
                    }
                } catch (error) {
                    alert('‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
            };
            
            reader.readAsText(file);
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Export/Import ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        window.addEventListener('load', function() {
            const settingsTab = document.getElementById('settings');
            const exportImportCard = document.createElement('div');
            exportImportCard.className = 'card';
            exportImportCard.innerHTML = `
                <h3>üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <div class="form-group">
                    <button class="btn btn-primary" onclick="exportData()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
                    <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                <div class="form-group">
                    <button class="btn btn-success" onclick="startBarcodeScanner()">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</button>
                </div>
            `;
            
            settingsTab.appendChild(exportImportCard);
        });

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
            const firstTime = localStorage.getItem('pos_first_time');
            if (!firstTime) {
                setTimeout(() => {
                    alert(`
üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö POS!

‚å®Ô∏è ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î:
F1 = ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
F2 = ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
F3 = ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á
F4 = ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô

üí° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö "‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
                    `);
                    localStorage.setItem('pos_first_time', 'true');
                }, 1000);
            }

            updateLastSaveDisplay();
        });

        // === Offline Support ===
        
        window.addEventListener('online', function() {
            console.log('‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            syncWithGoogleSheets();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            const notification = document.createElement('div');
            notification.className = 'alert alert-success';
            notification.textContent = 'üü¢ ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '1000';
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        });
        
        window.addEventListener('offline', function() {
            console.log('‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Local Storage');

            const notification = document.createElement('div');
            notification.className = 'alert alert-warning';
            notification.textContent = 'üü° ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '1000';

            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        });

        // === Auto-save ===

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        function updateLastSaveDisplay() {
            const last = localStorage.getItem('pos_last_save');
            const el = document.getElementById('lastSaved');
            if (el) {
                el.textContent = last ? `üïí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(last).toLocaleString()}` : '';
            }
        }

        function autoSave() {
            localStorage.setItem('pos_inventory', JSON.stringify(inventory));
            localStorage.setItem('pos_sales', JSON.stringify(sales));
            localStorage.setItem('pos_settings', JSON.stringify(settings));
            const now = new Date().toISOString();
            localStorage.setItem('pos_last_save', now);
            updateLastSaveDisplay();
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å autoSave ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
        const originalAddStock = addStock;
        const originalProcessSale = processSale;
        
        addStock = function() {
            originalAddStock();
            autoSave();
        };
        
        processSale = function() {
            originalProcessSale();
            autoSave();
        };

        console.log('üè™ POS System ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        console.log('üìä ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:', inventory.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        console.log('üí∞ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:', sales.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    </script>
</body>
</html>
